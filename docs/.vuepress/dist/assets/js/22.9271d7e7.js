(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{392:function(s,t,a){"use strict";a.r(t);var e=a(46),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"集群部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#集群部署"}},[s._v("#")]),s._v(" 集群部署")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("作者：青牛踏雪御苍穹（CoDo老王)")])]),s._v(" "),a("li",[s._v("部署 ETCD 集群（自签证书）")])]),s._v(" "),a("h3",{attrs:{id:"准备工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),a("p",[s._v("操作系统：Ubuntu 18.04.3 LTS （本地环境） 集群部署（自签证书）")]),s._v(" "),a("p",[s._v("自行打通服务器之间的SSH免密，或者自己输入密码来完成复制操作。")]),s._v(" "),a("h3",{attrs:{id:"配置环境变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置环境变量"}},[s._v("#")]),s._v(" 配置环境变量")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'${ETCD_DIR}'")]),s._v("\nmkddir "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n#!/usr/bin/bash\n# etcd 版本\nexport ETCD_VERSION='3.4.14'\n\n# 集群节点\nexport ETCD0='192.168.1.220'\nexport ETCD1='192.168.1.221'\nexport ETCD2='192.168.1.222'\n\n# ETCD集群各机器 IP 数组\nexport NODE_IPS=("),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD0}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD1}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD2}")]),s._v(')\n\n# 集群各 IP 对应的主机名数组\nexport NODE_NAMES=(etcd-0 etcd-1 etcd-2)\n\n# etcd 集群服务地址列表\nexport ETCD_ENDPOINTS="https://'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD0}")]),s._v(":2379,https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD1}")]),s._v(":2379,https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD2}")]),s._v(':2379"\n\n# etcd 集群间通信的 IP 和端口\nexport ETCD_NODES="etcd-0=https://'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD0}")]),s._v(":2380,etcd-1=https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD1}")]),s._v(":2380,etcd-2=https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD2}")]),s._v(':2380"\n\n# etcd 目录\nexport ETCD_DIR="/data/etcd"\n\n# etcd 数据目录\nexport ETCD_DATA_DIR="/data/etcd/data"\n\n# etcd WAL 目录，建议是 SSD 磁盘分区，或者和 ETCD_DATA_DIR 不同的磁盘分区\nexport ETCD_WAL_DIR="/data/etcd/wal"\n\n# etcd 自签证书存放目录\nexport ETCD_CA_DIR=\'/data/etcd/ca\'\n\n# etcd 各个节点证书存放目录\nexport ETCD_ETC_DIR=\'/etc/etcd/cert\'\nEOF')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x environment.sh\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建存放数据、证书、WAl目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DATA_DIR}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_WAL_DIR}")]),s._v("\n")])])]),a("p",[s._v("配置本地hosts")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置本地host")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD0}")]),s._v(" etcd-1\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD1}")]),s._v(" etcd-2\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD2}")]),s._v(" etcd-3\nEOF")]),s._v("\n")])])]),a("h3",{attrs:{id:"下载和分发-etcd-二进制文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#下载和分发-etcd-二进制文件"}},[s._v("#")]),s._v(" 下载和分发 etcd 二进制文件")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/coreos/etcd/releases",target:"_blank",rel:"noopener noreferrer"}},[s._v("release"),a("OutboundLink")],1),s._v(" 查找自己需要的版本。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/coreos/etcd/releases/download/v"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_VERSION}")]),s._v("/etcd-v"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_VERSION}")]),s._v("-linux-amd64.tar.gz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" xvf etcd-v"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_VERSION}")]),s._v("-linux-amd64.tar.gz\n")])])]),a("h3",{attrs:{id:"分发二进制文件到各个主机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分发二进制文件到各个主机"}},[s._v("#")]),s._v(" 分发二进制文件到各个主机")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" -r /data/etcd/etcd-v"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_VERSION}")]),s._v("-linux-amd64/etcd* root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(":/usr/local/bin/\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chmod +x /usr/local/bin/etcd*"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\netcd                                                                                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   23MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v(".1MB/s   00:00\netcdctl                                                                                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   17MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v(".5MB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\netcd                                                                                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   23MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(".1MB/s   00:00\netcdctl                                                                                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   17MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v(".4MB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\netcd                                                                                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   23MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(".0MB/s   00:00\netcdctl                                                                                               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%   17MB  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(".8MB/s   00:00  \n")])])]),a("h3",{attrs:{id:"安装-cfssl-工具集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-cfssl-工具集"}},[s._v("#")]),s._v(" 安装 cfssl 工具集")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装cfssl")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl_1.4.1_linux_amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl_1.4.1_linux_amd64 /usr/local/bin/cfssl\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssljson")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssljson_1.4.1_linux_amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssljson_1.4.1_linux_amd64 /usr/local/bin/cfssljson\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cfssl-certinfo")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/cloudflare/cfssl/releases/download/v1.4.1/cfssl-certinfo_1.4.1_linux_amd64\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl-certinfo_1.4.1_linux_amd64 /usr/local/bin/cfssl-certinfo\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加执行权限")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /usr/local/bin/cfssl*\n")])])]),a("h3",{attrs:{id:"创建证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建证书"}},[s._v("#")]),s._v(" 创建证书")]),s._v(" "),a("p",[s._v("CA 配置文件用于配置根证书的使用场景 (profile) 和具体参数 (usage，过期时间、服务端认证、客户端认证、加密等)：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-config.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "signing": {\n    "default": {\n      "expiry": "87600h"\n    },\n    "profiles": {\n      "etcd-cluster": {\n        "usages": [\n            "signing",\n            "key encipherment",\n            "server auth",\n            "client auth"\n        ],\n        "expiry": "876000h"\n      }\n    }\n  }\n}\nEOF')]),s._v("\n")])])]),a("p",[s._v("创建证书签名请求文件")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "CN": "kubernetes-ca",\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "ST": "BeiJing",\n      "L": "BeiJing",\n      "O": "etcd",\n      "OU": "opsnull"\n    }\n  ],\n  "ca": {\n    "expiry": "876000h"\n }\n}\nEOF')]),s._v("\n")])])]),a("ul",[a("li",[a("code",[s._v("signing")]),s._v("：表示该证书可用于签名其它证书（生成的 "),a("code",[s._v("ca.pem")]),s._v(" 证书中 "),a("code",[s._v("CA=TRUE")]),s._v("）；")]),s._v(" "),a("li",[a("code",[s._v("server auth")]),s._v("：表示 client 可以用该该证书对 server 提供的证书进行验证；")]),s._v(" "),a("li",[a("code",[s._v("client auth")]),s._v("：表示 server 可以用该该证书对 client 提供的证书进行验证；")]),s._v(" "),a("li",[a("code",[s._v('"expiry": "876000h"')]),s._v("：证书有效期设置为 100 年；")])]),s._v(" "),a("h3",{attrs:{id:"创建证书签名请求文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建证书签名请求文件"}},[s._v("#")]),s._v(" 创建证书签名请求文件")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "CN": "kubernetes-ca",\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "ST": "BeiJing",\n      "L": "BeiJing",\n      "O": "etcd",\n      "OU": "opsnull"\n    }\n  ],\n  "ca": {\n    "expiry": "876000h"\n }\n}\nEOF')]),s._v("\n")])])]),a("ul",[a("li",[a("code",[s._v("CN：Common Name")]),s._v("：etcd 从证书中提取该字段作为请求的"),a("strong",[s._v("用户名 (User Name)")]),s._v("，浏览器使用该字段验证网站是否合法；")]),s._v(" "),a("li",[a("code",[s._v("O：Organization")]),s._v("：etcd 从证书中提取该字段作为请求用户所属的"),a("strong",[s._v("组 (Group)")]),s._v("； kube-apiserver 将提取的 "),a("code",[s._v("User、Group")]),s._v(" 作为 "),a("code",[s._v("RBAC")]),s._v(" 授权的用户标识；")])]),s._v(" "),a("h3",{attrs:{id:"生成证书文件和私钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成证书文件和私钥"}},[s._v("#")]),s._v(" 生成证书文件和私钥")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v(" \ncfssl gencert -initca ca-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson -bare ca\n输出结果：\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:25 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating a new CA key and certificate from CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:25 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:25 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:25 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 09:54:26 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("437386317969465523284385845194090172491501571515")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" ca*\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\nca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem\n")])])]),a("h3",{attrs:{id:"分发证书文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分发证书文件"}},[s._v("#")]),s._v(" 分发证书文件")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mkdir -p '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" ca*.pem ca-config.json root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\nca-key.pem                                                                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".2MB/s   00:00\nca.pem                                                                                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1326")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".2MB/s   00:00\nca-config.json                                                                                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("293")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("221")]),s._v(".9KB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\nca-key.pem                                                                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".1MB/s   00:00\nca.pem                                                                                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1326")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".2MB/s   00:00\nca-config.json                                                                                        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("293")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("180")]),s._v(".2KB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\nca-key.pem                                                                                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("973")]),s._v(".5KB/s   00:00\nca.pem                                                                                                "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1326")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("972")]),s._v(".0KB/s   00:00\nca-config.json  \n")])])]),a("p",[s._v("注意：")]),s._v(" "),a("ol",[a("li",[s._v("不同证书 csr 文件的 CN、C、ST、L、O、OU 组合必须不同，否则可能出现 PEER'S CERTIFICATE HAS AN INVALID SIGNATURE 错误；")]),s._v(" "),a("li",[s._v("后续创建证书的 csr 文件时，CN 都不相同（C、ST、L、O、OU 相同），以达到区分的目的；")])]),s._v(" "),a("p",[s._v("etcd-csr证书签名")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("hosts")]),s._v("：指定授权使用该证书的 etcd 节点 IP 列表，"),a("strong",[s._v("需要将 etcd 集群所有节点 IP 都列在其中")])])]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /data/etcd/ca/etcd-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n  "CN": "etcd",\n  "hosts": [\n    "127.0.0.1",\n    "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD0}")]),s._v('",\n    "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD1}")]),s._v('",\n    "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD2}")]),s._v('"\n  ],\n  "key": {\n    "algo": "rsa",\n    "size": 2048\n  },\n  "names": [\n    {\n      "C": "CN",\n      "ST": "BeiJing",\n      "L": "BeiJing",\n      "O": "etcd",\n      "OU": "opsnull"\n    }\n  ]\n}\nEOF')]),s._v("\n")])])]),a("p",[s._v("生成证书和私钥：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("cfssl gencert -ca"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v("/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -ca-key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v("/ca-key.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v("/ca-config.json "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -profile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("etcd-cluster "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v("/etcd-csr.json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson -bare etcd\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":03:52 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generate received request\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":03:52 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" received CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":03:52 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" generating key: rsa-2048\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":03:53 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" encoded CSR\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("/12/17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":03:53 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" signed certificate with serial number "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("290666497635689555552442344139619956527112356386")]),s._v("    \n")])])]),a("h3",{attrs:{id:"分发证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分发证书"}},[s._v("#")]),s._v(" 分发证书")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_CA_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" etcd*.pem root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\netcd-key.pem                                                                                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("279")]),s._v(".6KB/s   00:00\netcd.pem                                                                                              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1448")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".3MB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\netcd-key.pem                                                                                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("763")]),s._v(".6KB/s   00:00\netcd.pem                                                                                              "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1448")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".0MB/s   00:00\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\netcd-key.pem                                                                                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("% "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".0MB/s   00:00\netcd.pem\n")])])]),a("h3",{attrs:{id:"创建-etcd-的-systemd-unit-模板文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-etcd-的-systemd-unit-模板文件"}},[s._v("#")]),s._v(" 创建 etcd 的 systemd unit 模板文件")]),s._v(" "),a("p",[s._v("模板不需要做任何改动，所有需要替换的地方后续都会替换掉：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" etcd.service.template "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\nDocumentation=https://github.com/coreos\n\n[Service]\nType=notify\nWorkingDirectory="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DATA_DIR}")]),s._v("\nExecStart=/usr/local/bin/etcd "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --data-dir="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DATA_DIR}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --wal-dir="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_WAL_DIR}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --name=##NODE_NAME## "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --cert-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --key-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd-key.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --trusted-ca-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/ca.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --peer-cert-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --peer-key-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd-key.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --peer-trusted-ca-file="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/ca.pem "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --peer-client-cert-auth "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --client-cert-auth "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --listen-peer-urls=https://##NODE_IP##:2380 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --initial-advertise-peer-urls=https://##NODE_IP##:2380 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --listen-client-urls=https://##NODE_IP##:2379,http://127.0.0.1:2379 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --advertise-client-urls=https://##NODE_IP##:2379 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --initial-cluster-token=etcd-cluster-0 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --initial-cluster="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_NODES}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --initial-cluster-state=new "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --auto-compaction-mode=periodic "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --auto-compaction-retention=1 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --max-request-bytes=33554432 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --quota-backend-bytes=6442450944 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --heartbeat-interval=250 "),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n  --election-timeout=2000\nRestart=on-failure\nRestartSec=5\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])])]),a("p",[s._v("参数说明：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("WorkingDirectory")]),s._v("、"),a("code",[s._v("--data-dir")]),s._v("：指定工作目录和数据目录为 "),a("code",[s._v("${ETCD_DATA_DIR}")]),s._v("，需在启动服务前创建这个目录；")]),s._v(" "),a("li",[a("code",[s._v("--wal-dir")]),s._v("：指定 wal 目录，为了提高性能，一般使用 SSD 或者和 "),a("code",[s._v("--data-dir")]),s._v(" 不同的磁盘；")]),s._v(" "),a("li",[a("code",[s._v("--name")]),s._v("：指定节点名称，当 "),a("code",[s._v("--initial-cluster-state")]),s._v(" 值为 new 时，"),a("code",[s._v("--name")]),s._v(" 的参数值必须位于 "),a("code",[s._v("--initial-cluster")]),s._v(" 列表中；")]),s._v(" "),a("li",[a("code",[s._v("--cert-file、--key-file")]),s._v("：etcd server 与 client 通信时使用的证书和私钥；")]),s._v(" "),a("li",[a("code",[s._v("--trusted-ca-file")]),s._v("：签名 client 证书的 CA 证书，用于验证 client 证书；")]),s._v(" "),a("li",[a("code",[s._v("--peer-cert-file")]),s._v("、"),a("code",[s._v("--peer-key-file")]),s._v("：etcd 与 peer 通信使用的证书和私钥；")]),s._v(" "),a("li",[a("code",[s._v("--peer-trusted-ca-file")]),s._v("：签名 peer 证书的 CA 证书，用于验证 peer 证书；")])]),s._v(" "),a("h3",{attrs:{id:"创建和分发-etcd-systemd-unit-文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建和分发-etcd-systemd-unit-文件"}},[s._v("#")]),s._v(" 创建和分发 etcd systemd unit 文件")]),s._v(" "),a("p",[s._v("替换模板文件中的变量，为各节点创建 systemd unit 文件：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("((")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("))")])]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/##NODE_NAME##/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_NAMES"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('/"')]),s._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/##NODE_IP##/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v('/"')]),s._v(" etcd.service.template "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" etcd-"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v(".service \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" *.service\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\netcd-192.168.1.220.service  etcd-192.168.1.221.service  etcd-192.168.1.222.service\n")])])]),a("ul",[a("li",[s._v("NODE_NAMES 和 NODE_IPS 为相同长度的 bash 数组，分别为节点名称和对应的 IP；")])]),s._v(" "),a("p",[s._v("分发生成的 systemd unit 文件：")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" etcd-"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(".service root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(":/etc/systemd/system/etcd.service\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n")])])]),a("h3",{attrs:{id:"启动服务测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动服务测试"}},[s._v("#")]),s._v(" 启动服务测试")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mkdir -p '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DATA_DIR}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_WAL_DIR}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"systemctl daemon-reload && systemctl enable etcd && systemctl restart etcd "')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26642")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26729")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26840")]),s._v("\n")])])]),a("ul",[a("li",[s._v("命令首先创建 etcd 数据目录和工作目录")]),s._v(" "),a("li",[s._v("etcd 进程首次启动时会等待其它节点的 etcd 加入集群，命令 "),a("code",[s._v("systemctl start etcd")]),s._v(" 会卡住一段时间，为正常现象")])]),s._v(" "),a("h3",{attrs:{id:"检查启动结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查启动结果"}},[s._v("#")]),s._v(" 检查启动结果")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"systemctl status etcd|grep Active"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n\n输出结果：\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Thu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":15:02 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 31s ago\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Thu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":15:02 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 36s ago\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\n   Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Thu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-12-17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":15:02 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 40s ago  \n")])])]),a("h3",{attrs:{id:"验证etcd集群服务状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#验证etcd集群服务状态"}},[s._v("#")]),s._v(" 验证ETCD集群服务状态")]),s._v(" "),a("p",[s._v("部署完 etcd 集群后，在任一 "),a("code",[s._v("etcd")]),s._v(" 节点上执行如下命令，我是etcd-0执行的部署操作。")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("source")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_DIR}")]),s._v("/environment.sh\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token for-or-select variable"}},[s._v("node_ip")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${NODE_IPS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('">>> '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v('"')]),s._v("\n    /usr/local/bin/etcdctl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --endpoints"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${node_ip}")]),s._v(":2379 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --cacert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/ca.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --cert"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    --key"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ETCD_ETC_DIR}")]),s._v("/etcd-key.pem endpoint health\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出结果：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.220\nhttps://192.168.1.220:2379 is healthy: successfully committed proposal: took "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("99")]),s._v(".689319ms\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.221\nhttps://192.168.1.221:2379 is healthy: successfully committed proposal: took "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(".262066ms\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.222\nhttps://192.168.1.222:2379 is healthy: successfully committed proposal: took "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v(".330772ms\n")])])]),a("p",[s._v("ok, etcd集群已经部署完成.")])])}),[],!1,null,null,null);t.default=n.exports}}]);